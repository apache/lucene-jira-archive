From 72df42a8ce772864e7e345cefeb843fe41e1fb48 Mon Sep 17 00:00:00 2001
From: Dan Meehl <dmeehl@kmwllc.com>
Date: Fri, 18 Jan 2019 16:37:27 -0500
Subject: [PATCH] LUCENE-8650 - Fix ConcatenatingTokenStream

---
 .../lucene/analysis/miscellaneous/ConcatenatingTokenStream.java       | 4 ++++
 1 file changed, 4 insertions(+)

diff --git a/lucene/analysis/common/src/java/org/apache/lucene/analysis/miscellaneous/ConcatenatingTokenStream.java b/lucene/analysis/common/src/java/org/apache/lucene/analysis/miscellaneous/ConcatenatingTokenStream.java
index 960cae1..f1e01f7 100644
--- a/lucene/analysis/common/src/java/org/apache/lucene/analysis/miscellaneous/ConcatenatingTokenStream.java
+++ b/lucene/analysis/common/src/java/org/apache/lucene/analysis/miscellaneous/ConcatenatingTokenStream.java
@@ -43,6 +43,7 @@ public final class ConcatenatingTokenStream extends TokenStream {
 
   private int currentSource;
   private int offsetIncrement;
+  private int finalOffset;
 
   /**
    * Create a new ConcatenatingTokenStream from a set of inputs
@@ -91,6 +92,7 @@ public final class ConcatenatingTokenStream extends TokenStream {
     clearAttributes();
     sources[currentSource].copyTo(this);
     offsetAtt.setOffset(offsetAtt.startOffset() + offsetIncrement, offsetAtt.endOffset() + offsetIncrement);
+    finalOffset = offsetAtt.endOffset();
 
     return true;
   }
@@ -99,6 +101,7 @@ public final class ConcatenatingTokenStream extends TokenStream {
   public void end() throws IOException {
     sources[currentSource].end();
     super.end();
+    offsetAtt.setOffset(0, finalOffset);
   }
 
   @Override
@@ -107,6 +110,7 @@ public final class ConcatenatingTokenStream extends TokenStream {
       source.reset();
     }
     super.reset();
+    currentSource = offsetIncrement = finalOffset = 0;
   }
 
   @Override
-- 
2.7.4

