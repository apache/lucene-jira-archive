Index: src/java/org/apache/lucene/analysis/phonetic/DaitchMokotoffSoundexFilter.java
===================================================================
--- src/java/org/apache/lucene/analysis/phonetic/DaitchMokotoffSoundexFilter.java	(revision 0)
+++ src/java/org/apache/lucene/analysis/phonetic/DaitchMokotoffSoundexFilter.java	(working copy)
@@ -0,0 +1,98 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one or more
+ * contributor license agreements.  See the NOTICE file distributed with
+ * this work for additional information regarding copyright ownership.
+ * The ASF licenses this file to You under the Apache License, Version 2.0
+ * (the "License"); you may not use this file except in compliance with
+ * the License.  You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.apache.lucene.analysis.phonetic;
+
+import java.io.IOException;
+import java.util.regex.Matcher;
+import java.util.regex.Pattern;
+
+import org.apache.commons.codec.language.DaitchMokotoffSoundex;
+import org.apache.lucene.analysis.TokenFilter;
+import org.apache.lucene.analysis.TokenStream;
+import org.apache.lucene.analysis.tokenattributes.CharTermAttribute;
+import org.apache.lucene.analysis.tokenattributes.PositionIncrementAttribute;
+
+/**
+ * Create tokens for phonetic matches based on Daitch–Mokotoff Soundex.
+ */
+public final class DaitchMokotoffSoundexFilter extends TokenFilter {
+  /** true if encoded tokens should be added as synonyms */
+  protected boolean inject = true;
+  /** phonetic encoder */
+  protected DaitchMokotoffSoundex encoder = new DaitchMokotoffSoundex();
+
+  // output is a string such as ab|ac|...
+  private static final Pattern pattern = Pattern.compile("([^|]+)");
+
+  // matcher over any buffered output
+  private final Matcher matcher = pattern.matcher("");
+
+  // encoded representation
+  private String encoded;
+  // preserves all attributes for any buffered outputs
+  private State state;
+
+  private final CharTermAttribute termAtt = addAttribute(CharTermAttribute.class);
+  private final PositionIncrementAttribute posAtt = addAttribute(PositionIncrementAttribute.class);
+
+  /**
+   * Creates a DaitchMokotoffSoundexFilter by either adding encoded forms as synonyms (
+   * <code>inject=true</code>) or replacing them.
+   */
+  public DaitchMokotoffSoundexFilter(TokenStream in, boolean inject) {
+    super(in);
+    this.inject = inject;
+  }
+
+  @Override
+  public boolean incrementToken() throws IOException {
+    if (matcher.find()) {
+      assert state != null && encoded != null;
+      restoreState(state);
+      termAtt.setEmpty().append(encoded, matcher.start(1), matcher.end(1));
+      posAtt.setPositionIncrement(0);
+      return true;
+    }
+
+    if (input.incrementToken()) {
+      // pass through zero-length terms
+      if (termAtt.length() == 0) {
+        return true;
+      }
+
+      encoded = encoder.soundex(termAtt.toString());
+      state = captureState();
+      matcher.reset(encoded);
+
+      if (!inject) {
+        if (matcher.find()) {
+          termAtt.setEmpty().append(encoded, matcher.start(1), matcher.end(1));
+        }
+      }
+      return true;
+    } else {
+      return false;
+    }
+  }
+
+  @Override
+  public void reset() throws IOException {
+    super.reset();
+    matcher.reset("");
+    state = null;
+  }
+}

Property changes on: src/java/org/apache/lucene/analysis/phonetic/DaitchMokotoffSoundexFilter.java
___________________________________________________________________
Added: svn:eol-style
## -0,0 +1 ##
+native
\ No newline at end of property
Added: svn:mime-type
## -0,0 +1 ##
+text/plain
\ No newline at end of property
Added: svn:keywords
## -0,0 +1 ##
+Id Revision HeadURL
\ No newline at end of property
Index: src/java/org/apache/lucene/analysis/phonetic/DaitchMokotoffSoundexFilterFactory.java
===================================================================
--- src/java/org/apache/lucene/analysis/phonetic/DaitchMokotoffSoundexFilterFactory.java	(revision 0)
+++ src/java/org/apache/lucene/analysis/phonetic/DaitchMokotoffSoundexFilterFactory.java	(working copy)
@@ -0,0 +1,79 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one or more
+ * contributor license agreements.  See the NOTICE file distributed with
+ * this work for additional information regarding copyright ownership.
+ * The ASF licenses this file to You under the Apache License, Version 2.0
+ * (the "License"); you may not use this file except in compliance with
+ * the License.  You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.apache.lucene.analysis.phonetic;
+
+/*
+ * contributor license agreements.  See the NOTICE file distributed with
+ * this work for additional information regarding copyright ownership.
+ * The ASF licenses this file to You under the Apache License, Version 2.0
+ * (the "License"); you may not use this file except in compliance with
+ * the License.  You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+import java.util.Map;
+
+import org.apache.lucene.analysis.TokenStream;
+import org.apache.lucene.analysis.util.TokenFilterFactory;
+
+/**
+ * Factory for {@link DaitchMokotoffSoundexFilter}.
+ *
+ * Create tokens based on Daitch–Mokotoff Soundex phonetic filter.
+ * <p>
+ * This takes one optional argument:
+ * <dl>
+ *  <dt>inject</dt><dd> (default=true) add tokens to the stream with the offset=0</dd>
+ * </dl>
+ *
+ * <pre class="prettyprint">
+ * &lt;fieldType name="text_phonetic" class="solr.TextField" positionIncrementGap="100"&gt;
+ *   &lt;analyzer&gt;
+ *     &lt;tokenizer class="solr.WhitespaceTokenizerFactory"/&gt;
+ *     &lt;filter class="solr.DaitchMokotoffSoundexFilterFactory" inject="true"/&gt;
+ *   &lt;/analyzer&gt;
+ * &lt;/fieldType&gt;</pre>
+ *
+ * @see DaitchMokotoffSoundexFilter
+ */
+public class DaitchMokotoffSoundexFilterFactory extends TokenFilterFactory {
+  /** parameter name: true if encoded tokens should be added as synonyms */
+  public static final String INJECT = "inject"; // boolean
+
+  final boolean inject; //accessed by the test
+
+  /** Creates a new PhoneticFilterFactory */
+  public DaitchMokotoffSoundexFilterFactory(Map<String,String> args) {
+    super(args);
+    inject = getBoolean(args, INJECT, true);
+    if (!args.isEmpty()) {
+      throw new IllegalArgumentException("Unknown parameters: " + args);
+    }
+  }
+
+  @Override
+  public DaitchMokotoffSoundexFilter create(TokenStream input) {
+    return new DaitchMokotoffSoundexFilter(input, inject);
+  }
+
+}

Property changes on: src/java/org/apache/lucene/analysis/phonetic/DaitchMokotoffSoundexFilterFactory.java
___________________________________________________________________
Added: svn:eol-style
## -0,0 +1 ##
+native
\ No newline at end of property
Added: svn:mime-type
## -0,0 +1 ##
+text/plain
\ No newline at end of property
Added: svn:keywords
## -0,0 +1 ##
+Id Revision HeadURL
\ No newline at end of property
Index: src/test/org/apache/lucene/analysis/phonetic/TestDaitchMokotoffSoundexFilter.java
===================================================================
--- src/test/org/apache/lucene/analysis/phonetic/TestDaitchMokotoffSoundexFilter.java	(revision 0)
+++ src/test/org/apache/lucene/analysis/phonetic/TestDaitchMokotoffSoundexFilter.java	(working copy)
@@ -0,0 +1,84 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one or more
+ * contributor license agreements.  See the NOTICE file distributed with
+ * this work for additional information regarding copyright ownership.
+ * The ASF licenses this file to You under the Apache License, Version 2.0
+ * (the "License"); you may not use this file except in compliance with
+ * the License.  You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.apache.lucene.analysis.phonetic;
+
+import java.io.IOException;
+import java.io.Reader;
+import java.io.StringReader;
+
+import org.apache.lucene.analysis.Analyzer;
+import org.apache.lucene.analysis.BaseTokenStreamTestCase;
+import org.apache.lucene.analysis.MockTokenizer;
+import org.apache.lucene.analysis.Tokenizer;
+import org.apache.lucene.analysis.core.KeywordTokenizer;
+import org.apache.lucene.analysis.core.WhitespaceTokenizer;
+
+/**
+ * Tests {@link DaitchMokotoffSoundexFilter}
+ */
+public class TestDaitchMokotoffSoundexFilter extends BaseTokenStreamTestCase {
+
+  public void testAlgorithms() throws Exception {
+    assertAlgorithm(true, "aaa bbb ccc easgasg",
+      new String[] { "aaa", "000000", "bbb", "700000", "ccc", "400000", "450000", "454000",
+        "540000", "545000", "500000", "easgasg", "045450" });
+    assertAlgorithm(false, "aaa bbb ccc easgasg",
+      new String[] { "000000", "700000", "400000", "450000", "454000", "540000", "545000",
+        "500000", "045450" });
+  }
+
+  static void assertAlgorithm(boolean inject, String input, String[] expected) throws Exception {
+    Tokenizer tokenizer = new WhitespaceTokenizer(new StringReader(input));
+    DaitchMokotoffSoundexFilter filter = new DaitchMokotoffSoundexFilter(tokenizer, inject);
+    assertTokenStreamContents(filter, expected);
+  }
+
+  /** blast some random strings through the analyzer */
+  public void testRandomStrings() throws IOException {
+    Analyzer a = new Analyzer() {
+      @Override
+      protected TokenStreamComponents createComponents(String fieldName, Reader reader) {
+        Tokenizer tokenizer = new MockTokenizer(reader, MockTokenizer.WHITESPACE, false);
+        return new TokenStreamComponents(tokenizer, new DaitchMokotoffSoundexFilter(tokenizer, false));
+      }
+    };
+
+    checkRandomData(random(), a, 1000 * RANDOM_MULTIPLIER);
+
+    Analyzer b = new Analyzer() {
+      @Override
+      protected TokenStreamComponents createComponents(String fieldName, Reader reader) {
+        Tokenizer tokenizer = new MockTokenizer(reader, MockTokenizer.WHITESPACE, false);
+        return new TokenStreamComponents(tokenizer, new DaitchMokotoffSoundexFilter(tokenizer, false));
+      }
+    };
+
+    checkRandomData(random(), b, 1000 * RANDOM_MULTIPLIER);
+  }
+
+  public void testEmptyTerm() throws IOException {
+    Analyzer a = new Analyzer() {
+      @Override
+      protected TokenStreamComponents createComponents(String fieldName, Reader reader) {
+        Tokenizer tokenizer = new KeywordTokenizer(reader);
+        return new TokenStreamComponents(tokenizer, new DaitchMokotoffSoundexFilter(tokenizer, random().nextBoolean()));
+      }
+    };
+    checkOneTerm(a, "", "");
+  }
+
+}

Property changes on: src/test/org/apache/lucene/analysis/phonetic/TestDaitchMokotoffSoundexFilter.java
___________________________________________________________________
Added: svn:eol-style
## -0,0 +1 ##
+native
\ No newline at end of property
Added: svn:mime-type
## -0,0 +1 ##
+text/plain
\ No newline at end of property
Added: svn:keywords
## -0,0 +1 ##
+Id Revision HeadURL
\ No newline at end of property
Index: src/test/org/apache/lucene/analysis/phonetic/TestDaitchMokotoffSoundexFilterFactory.java
===================================================================
--- src/test/org/apache/lucene/analysis/phonetic/TestDaitchMokotoffSoundexFilterFactory.java	(revision 0)
+++ src/test/org/apache/lucene/analysis/phonetic/TestDaitchMokotoffSoundexFilterFactory.java	(working copy)
@@ -0,0 +1,62 @@
+package org.apache.lucene.analysis.phonetic;
+
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one or more
+ * contributor license agreements.  See the NOTICE file distributed with
+ * this work for additional information regarding copyright ownership.
+ * The ASF licenses this file to You under the Apache License, Version 2.0
+ * (the "License"); you may not use this file except in compliance with
+ * the License.  You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import java.io.StringReader;
+import java.util.HashMap;
+import java.util.Map;
+
+import org.apache.lucene.analysis.BaseTokenStreamTestCase;
+import org.apache.lucene.analysis.MockTokenizer;
+import org.apache.lucene.analysis.TokenStream;
+
+public class TestDaitchMokotoffSoundexFilterFactory extends BaseTokenStreamTestCase {
+
+  public void testDefaults() throws Exception {
+    DaitchMokotoffSoundexFilterFactory factory = new DaitchMokotoffSoundexFilterFactory(new HashMap<String, String>());
+    TokenStream inputStream = new MockTokenizer(new StringReader("international"), MockTokenizer.WHITESPACE, false);
+
+    TokenStream filteredStream = factory.create(inputStream);
+    assertEquals(DaitchMokotoffSoundexFilter.class, filteredStream.getClass());
+    assertTokenStreamContents(filteredStream, new String[] { "international", "063963" });
+  }
+
+  public void testSettingInject() throws Exception {
+    Map<String,String> parameters = new HashMap<>();
+    parameters.put("inject", "false");
+    DaitchMokotoffSoundexFilterFactory factory = new DaitchMokotoffSoundexFilterFactory(parameters);
+
+    TokenStream inputStream = new MockTokenizer(new StringReader("international"), MockTokenizer.WHITESPACE, false);
+
+    TokenStream filteredStream = factory.create(inputStream);
+    assertEquals(DaitchMokotoffSoundexFilter.class, filteredStream.getClass());
+    assertTokenStreamContents(filteredStream, new String[] { "063963" });
+  }
+  
+  /** Test that bogus arguments result in exception */
+  public void testBogusArguments() throws Exception {
+    try {
+      new DaitchMokotoffSoundexFilterFactory(new HashMap<String,String>() {{
+        put("bogusArg", "bogusValue");
+      }});
+      fail();
+    } catch (IllegalArgumentException expected) {
+      assertTrue(expected.getMessage().contains("Unknown parameters"));
+    }
+  }
+}

Property changes on: src/test/org/apache/lucene/analysis/phonetic/TestDaitchMokotoffSoundexFilterFactory.java
___________________________________________________________________
Added: svn:eol-style
## -0,0 +1 ##
+native
\ No newline at end of property
Added: svn:mime-type
## -0,0 +1 ##
+text/plain
\ No newline at end of property
Added: svn:keywords
## -0,0 +1 ##
+Id Revision HeadURL
\ No newline at end of property
