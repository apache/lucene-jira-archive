From 769b7c652604068b85c49d448258a761eadcd004 Mon Sep 17 00:00:00 2001
From: Bjarke Buur Mortensen <mortensen@eluence.com>
Date: Tue, 11 Sep 2018 21:44:27 +0200
Subject: [PATCH] Added support for nested synonym queries in
 ComplexPhraseQueryParser

Better test case query
---
 .../queryparser/complexPhrase/ComplexPhraseQueryParser.java  | 5 +++--
 .../queryparser/complexPhrase/TestComplexPhraseQuery.java    | 3 ++-
 2 files changed, 5 insertions(+), 3 deletions(-)

diff --git a/lucene/queryparser/src/java/org/apache/lucene/queryparser/complexPhrase/ComplexPhraseQueryParser.java b/lucene/queryparser/src/java/org/apache/lucene/queryparser/complexPhrase/ComplexPhraseQueryParser.java
index ffe0066ed1d..c1343e954b8 100644
--- a/lucene/queryparser/src/java/org/apache/lucene/queryparser/complexPhrase/ComplexPhraseQueryParser.java
+++ b/lucene/queryparser/src/java/org/apache/lucene/queryparser/complexPhrase/ComplexPhraseQueryParser.java
@@ -395,8 +395,9 @@ public class ComplexPhraseQueryParser extends QueryParser {
             stq = new SpanBoostQuery(stq, boost);
           }
           chosenList.add(stq);
-        } else if (childQuery instanceof BooleanQuery) {
-          BooleanQuery cbq = (BooleanQuery) childQuery;
+        } else if (childQuery instanceof BooleanQuery || childQuery instanceof SynonymQuery) {
+          BooleanQuery cbq = childQuery instanceof BooleanQuery ?
+              (BooleanQuery) childQuery : convert((SynonymQuery)childQuery);
           addComplexPhraseClause(chosenList, cbq);
         } else if (childQuery instanceof MatchNoDocsQuery) {
           // Insert fake term e.g. phrase query was for "Fred Smithe*" and
diff --git a/lucene/queryparser/src/test/org/apache/lucene/queryparser/complexPhrase/TestComplexPhraseQuery.java b/lucene/queryparser/src/test/org/apache/lucene/queryparser/complexPhrase/TestComplexPhraseQuery.java
index 5935da96048..f480d3a26df 100644
--- a/lucene/queryparser/src/test/org/apache/lucene/queryparser/complexPhrase/TestComplexPhraseQuery.java
+++ b/lucene/queryparser/src/test/org/apache/lucene/queryparser/complexPhrase/TestComplexPhraseQuery.java
@@ -101,7 +101,8 @@ public class TestComplexPhraseQuery extends LuceneTestCase {
     checkMatches("\"dogs cigar*\"~2","7,8", synonym);
     // synonym is unidirectional
     checkMatches("\"dog cigar*\"~2","7", synonym);
-    
+    // synonym works for sub queries
+    checkMatches("\"(cats OR dogs) cigar\"","7", synonym);
   }
   
   public void testUnOrderedProximitySearches() throws Exception {
-- 
2.17.1

