From f95f1f81c62c5ec612b116d1fd05227426995682 Mon Sep 17 00:00:00 2001
From: Johann Abraham <johann@beessip.com>
Date: Thu, 18 Apr 2019 13:51:27 -0600
Subject: [PATCH] Performance improvement for update?optimize=true

Bottleneck was FilterFieldInfor constructor filterFields.contains(...)
---
 .../org/apache/lucene/codecs/perfield/PerFieldDocValuesFormat.java    | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/lucene/core/src/java/org/apache/lucene/codecs/perfield/PerFieldDocValuesFormat.java b/lucene/core/src/java/org/apache/lucene/codecs/perfield/PerFieldDocValuesFormat.java
index eef232cfcd..9f27d45e00 100644
--- a/lucene/core/src/java/org/apache/lucene/codecs/perfield/PerFieldDocValuesFormat.java
+++ b/lucene/core/src/java/org/apache/lucene/codecs/perfield/PerFieldDocValuesFormat.java
@@ -18,10 +18,10 @@ package org.apache.lucene.codecs.perfield;
 
 import java.io.Closeable;
 import java.io.IOException;
-import java.util.ArrayList;
 import java.util.Collection;
 import java.util.HashMap;
 import java.util.IdentityHashMap;
+import java.util.LinkedHashSet;
 import java.util.Map;
 import java.util.ServiceLoader;
 import java.util.TreeMap;
@@ -138,7 +138,7 @@ public abstract class PerFieldDocValuesFormat extends DocValuesFormat {
         DocValuesConsumer consumer = getInstance(fi);
         Collection<String> fieldsForConsumer = consumersToField.get(consumer);
         if (fieldsForConsumer == null) {
-          fieldsForConsumer = new ArrayList<>();
+          fieldsForConsumer = new LinkedHashSet<>();
           consumersToField.put(consumer, fieldsForConsumer);
         }
         fieldsForConsumer.add(fi.name);
-- 
2.13.6 (Apple Git-96)

