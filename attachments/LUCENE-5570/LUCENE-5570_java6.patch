Index: lucene/CHANGES.txt
===================================================================
--- lucene/CHANGES.txt	(revision 1584861)
+++ lucene/CHANGES.txt	(working copy)
@@ -14,6 +14,9 @@
   directory outside of Lucene.  (Simon Willnauer, Shai Erera, Robert
   Muir, Mike McCandless)
 
+* LUCENE-5570: Don't let FSDirectory.sync() create new zero-byte files, instead throw
+  exception if a file is missing.  (Uwe Schindler, Mike McCandless, Robert Muir)
+
 ======================= Lucene 4.7.1 =======================
 
 Changes in Runtime Behavior

Property changes on: lucene/CHANGES.txt
___________________________________________________________________
Modified: svn:mergeinfo
   Merged /lucene/dev/branches/branch_4x/lucene/CHANGES.txt:r1584861
Index: lucene/core/src/java/org/apache/lucene/store/FSDirectory.java
===================================================================
--- lucene/core/src/java/org/apache/lucene/store/FSDirectory.java	(revision 1584861)
+++ lucene/core/src/java/org/apache/lucene/store/FSDirectory.java	(working copy)
@@ -500,7 +500,13 @@
       retryCount++;
       RandomAccessFile file = null;
       try {
+        // LUCENE-5570: throw FNFE if it doesnt exist
         try {
+          file = new RandomAccessFile(fullFile, "r");
+        } finally {
+          IOUtils.closeWhileHandlingException(file);
+        }
+        try {
           file = new RandomAccessFile(fullFile, "rw");
           file.getFD().sync();
           success = true;
Index: lucene/core/src/test/org/apache/lucene/store/TestDirectory.java
===================================================================
--- lucene/core/src/test/org/apache/lucene/store/TestDirectory.java	(revision 1584861)
+++ lucene/core/src/test/org/apache/lucene/store/TestDirectory.java	(working copy)
@@ -21,6 +21,7 @@
 import java.io.FileNotFoundException;
 import java.io.IOException;
 import java.util.Arrays;
+import java.util.Collections;
 
 import org.apache.lucene.store.MockDirectoryWrapper.Throttling;
 import org.apache.lucene.util.LuceneTestCase;
@@ -286,5 +287,34 @@
       _TestUtil.rmDir(path);
     }
   }
+  
+  public void testFsyncDoesntCreateNewFiles() throws Exception {
+    File path = _TestUtil.getTempDir("nocreate");
+    Directory fsdir = new SimpleFSDirectory(path);
+    
+    // write a file
+    IndexOutput out = fsdir.createOutput("afile", newIOContext(random()));
+    out.writeString("boo");
+    out.close();
+    
+    // delete it
+    assertTrue(new File(path, "afile").delete());
+    
+    // directory is empty
+    assertEquals(0, fsdir.listAll().length);
+    
+    // fsync it
+    try {
+      fsdir.sync(Collections.singleton("afile"));
+      fail("didn't get expected exception, instead fsync created new files: " + Arrays.asList(fsdir.listAll()));
+    } catch (FileNotFoundException expected) {
+      // ok
+    }
+    
+    // directory is still empty
+    assertEquals(0, fsdir.listAll().length);
+    
+    fsdir.close();
+  }
 }
 
Index: lucene/core
===================================================================
--- lucene/core	(revision 1584861)
+++ lucene/core	(working copy)

Property changes on: lucene/core
___________________________________________________________________
Modified: svn:mergeinfo
   Merged /lucene/dev/branches/branch_4x/lucene/core:r1584861
   Merged /lucene/dev/trunk/lucene/core:r1584860
Index: lucene
===================================================================
--- lucene	(revision 1584861)
+++ lucene	(working copy)

Property changes on: lucene
___________________________________________________________________
Modified: svn:mergeinfo
   Merged /lucene/dev/branches/branch_4x/lucene:r1584861
   Merged /lucene/dev/trunk/lucene:r1584860
Index: .
===================================================================
--- .	(revision 1584861)
+++ .	(working copy)

Property changes on: .
___________________________________________________________________
Modified: svn:mergeinfo
   Merged /lucene/dev/branches/branch_4x:r1584861
   Merged /lucene/dev/trunk:r1584860
