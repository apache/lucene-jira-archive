From 0c3bc96a0f885f0fb1424ca5e813e41a34584f06 Mon Sep 17 00:00:00 2001
From: Atri Sharma <atri@apache.org>
Date: Mon, 3 Jun 2019 13:48:31 +0530
Subject: [PATCH] LUCENE-8819: Only Check For DocID Sequences Across Segments,
 Not Within

---
 .../org/apache/lucene/search/AssertingCollector.java     | 9 +++++++--
 1 file changed, 7 insertions(+), 2 deletions(-)

diff --git a/lucene/test-framework/src/java/org/apache/lucene/search/AssertingCollector.java b/lucene/test-framework/src/java/org/apache/lucene/search/AssertingCollector.java
index fb7991d254..889935837a 100644
--- a/lucene/test-framework/src/java/org/apache/lucene/search/AssertingCollector.java
+++ b/lucene/test-framework/src/java/org/apache/lucene/search/AssertingCollector.java
@@ -27,6 +27,7 @@ class AssertingCollector extends FilterCollector {
 
   private int maxDoc = -1;
   private int previousLeafMaxDoc = -1;
+  private int currentLeafOrd = -1;
 
   /** Wrap the given collector in order to add assertions. */
   public static Collector wrap(Collector in) {
@@ -52,8 +53,12 @@ class AssertingCollector extends FilterCollector {
         assert docBase + doc >= maxDoc : "collection is not in order: current doc="
             + (docBase + doc) + " while " + maxDoc + " has already been collected";
 
-        assert context.docBase >= previousLeafMaxDoc;
-        previousLeafMaxDoc = context.docBase + context.reader().maxDoc();
+        // At segment boundaries, check that segment docID ranges are ordered by docIDs
+        if (context.ord != currentLeafOrd) {
+          assert context.docBase >= previousLeafMaxDoc;
+          previousLeafMaxDoc = context.docBase + context.reader().maxDoc();
+          currentLeafOrd = context.ord;
+        }
 
         super.collect(doc);
         maxDoc = docBase + doc;
-- 
2.17.2 (Apple Git-113)

