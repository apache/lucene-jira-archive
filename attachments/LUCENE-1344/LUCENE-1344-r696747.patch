Index: build.xml
===================================================================
--- build.xml	(revision 696747)
+++ build.xml	(working copy)
@@ -25,6 +25,9 @@
 
   <property name="build.demo.template" value="src/demo/demo-build.template"/> 
 
+  <!-- template manifest to produce an OSGI bundle for the core -->
+  <property name="bundle.manifest.file" location="META-INF/MANIFEST.MF"/> 
+
   <property name="demo.name" value="lucene-demos-${version}"/>
   <property name="demo.war.name" value="luceneweb"/>
 
Index: common-build.xml
===================================================================
--- common-build.xml	(revision 696747)
+++ common-build.xml	(working copy)
@@ -36,12 +36,19 @@
     <format property="current.year" pattern="yyyy"/>
     <format property="DSTAMP" pattern="yyyy-MM-dd"/>
     <format property="TSTAMP" pattern="HH:mm:ss"/>
+  	<format property="timestamp.version" pattern="yyyyMMddHHmmss"/>
   </tstamp>
 
   <property name="name" value="${ant.project.name}"/>
   <property name="Name" value="Lucene"/>
-  <property name="version" value="2.9-dev"/>
-  <property name="spec.version" value="${version}"/>	
+  <!-- base version that should be of exactly 3 numbers -->
+  <property name="spec.version" value="2.9.0"/>
+  <!-- give a 'state' name to the build (dev, alpha, rc, final,...) -->
+  <property name="qualifier.version" value="dev"/>
+  <!-- the version used for ordinary jars, distrib zip and for maven -->
+  <property name="version" value="${spec.version}-${qualifier.version}"/>
+  <!-- the version to use in an OSGi environment -->
+  <property name="bundle.version" value="${spec.version}.${timestamp.version}-${qualifier.version}"/>
   <property name="year" value="2000-${current.year}"/>
   <property name="final.name" value="lucene-${name}-${version}"/>
 
@@ -228,8 +235,19 @@
     <!-- convenience target to compile core -->
   </target>
 
-  <target name="jar-core" depends="compile-core"
+  <!-- target to build the jar. The jar will be an OSGI one if a template is
+       defined by the property bundle.manifest.file -->
+  <target name="jar-core" depends="jar-plain-core,jar-bundle-core"
     description="Packages the JAR file">
+  </target>
+
+  <target name="jar-bundle-core" depends="compile-core"
+    description="Packages the bundle JAR file" if="bundle.manifest.file">
+    <bundlify/>
+  </target>
+
+  <target name="jar-plain-core" depends="compile-core"
+    description="Packages the JAR file" unless="bundle.manifest.file">
     <jarify/>
   </target>
 
@@ -291,11 +309,12 @@
 	  </manifest>
   	</sequential>
   </macrodef>
-	
+
+  <!-- macro that create a simple (non-OSGi) jar (see also the "bundlify" macro) -->
   <macrodef name="jarify" description="Builds a JAR file">
   	<attribute name="basedir" default="${build.dir}/classes/java"/>
   	<attribute name="destfile" default="${build.dir}/${final.name}.jar"/>
-    <element name="manifest-attributes" optional="yes"/>
+  	<element name="manifest-attributes" optional="yes"/>
   	<element name="metainf-includes" optional="yes"/>
     <sequential>
       <!-- If possible, include the svnversion -->
@@ -322,6 +341,56 @@
     </sequential>
   </macrodef>
 
+  <!-- macro that create the final OSGi MANIFEST.MF from a template -->
+  <macrodef name="build-bundle-manifest" description="Builds a manifest file">
+    <attribute name="title" default="Lucene Search Engine: ${ant.project.name}" />
+    <sequential>
+      <copy overwrite="true" file="${bundle.manifest.file}" tofile="${manifest.file}">
+        <filterchain>
+          <replaceregex pattern="Bundle-Version:.*" replace="Bundle-Version: ${bundle.version}" byline="true" />
+          <replaceregex pattern="Implementation-Version:.*" replace="Implementation-Version: ${version} ${svnversion} - ${DSTAMP} ${TSTAMP}" byline="true" />
+          <replaceregex pattern="Specification-Version:.*" replace="Specification-Version: ${spec.version}" byline="true" />
+          <replaceregex pattern="X-Compile-Source-JDK:.*" replace="X-Compile-Source-JDK: ${javac.source}" byline="true" />
+          <replaceregex pattern="X-Compile-Target-JDK:.*" replace="X-Compile-Target-JDK: ${javac.target}" byline="true" />
+          <replaceregex pattern="Bundle-RequiredExecutionEnvironment:.*" replace="Bundle-RequiredExecutionEnvironment: J2SE-${javac.target}" byline="true" />
+          <!-- regexp for the version in the export-package header -->
+          <replaceregex pattern="version=\&quot;[0-9]*\.[0-9]*\.[0-9]*\&quot;" replace="version=\&quot;${spec.version}\&quot;" byline="true" />
+        </filterchain>
+      </copy>
+    </sequential>
+  </macrodef>
+
+  <!-- a duplicate macro of "jarify" but the manifest is an OSGI one -->
+  <macrodef name="bundlify" description="Builds a bundle JAR file">
+  	<attribute name="basedir" default="${build.dir}/classes/java"/>
+  	<attribute name="destfile" default="${build.dir}/${final.name}.jar"/>
+  	<element name="manifest-attributes" optional="yes"/>
+  	<element name="metainf-includes" optional="yes"/>
+    <sequential>
+      <!-- If possible, include the svnversion -->
+      <exec dir="." executable="svnversion"
+            outputproperty="svnversion" failifexecutionfails="false">
+        <arg line="."/>
+      </exec>
+      
+      <build-bundle-manifest />
+      
+      <jar
+        destfile="@{destfile}"
+        basedir="@{basedir}"
+      	manifest="${manifest.file}">
+        <manifest>
+        	<manifest-attributes/>
+        </manifest>
+        <metainf dir="${common.dir}">
+          <include name="LICENSE.txt"/>
+          <include name="NOTICE.txt"/>
+        </metainf>
+        <metainf-includes/>
+      </jar>
+    </sequential>
+  </macrodef>
+
   <target name="compile-test" depends="compile-core">
     <compile
       srcdir="src/test"
Index: META-INF/MANIFEST.MF
===================================================================
--- META-INF/MANIFEST.MF	(revision 0)
+++ META-INF/MANIFEST.MF	(revision 0)
@@ -0,0 +1,29 @@
+Manifest-Version: 1.0
+Specification-Title: Lucene Search Engine: core
+Specification-Version: 2.9.0-dev
+Specification-Vendor: The Apache Software Foundation
+Implementation-Title: org.apache.lucene
+Implementation-Version: 2.9.0-dev
+Implementation-Vendor: The Apache Software Foundation
+X-Compile-Source-JDK: 1.4
+X-Compile-Target-JDK: 1.4
+Bundle-ManifestVersion: 2
+Bundle-Name: Apache Lucene core
+Bundle-SymbolicName: org.apache.lucene
+Bundle-Version: 2.9.0.dev
+Bundle-ClassPath: lucene.jar
+Export-Package: org.apache.lucene;version="2.9.0",
+ org.apache.lucene.analysis;version="2.9.0",
+ org.apache.lucene.analysis.standard;version="2.9.0",
+ org.apache.lucene.document;version="2.9.0",
+ org.apache.lucene.index;version="2.9.0",
+ org.apache.lucene.queryParser;version="2.9.0",
+ org.apache.lucene.search;version="2.9.0",
+ org.apache.lucene.search.function;version="2.9.0",
+ org.apache.lucene.search.payloads;version="2.9.0",
+ org.apache.lucene.search.spans;version="2.9.0",
+ org.apache.lucene.store;version="2.9.0",
+ org.apache.lucene.util;version="2.9.0",
+ org.apache.lucene.util.cache;version="2.9.0"
+Bundle-Vendor: The Apache Software Fondation
+Bundle-RequiredExecutionEnvironment: J2SE-1.4
