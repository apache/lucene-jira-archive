Index: lucene/core/src/java/org/apache/lucene/store/ByteArrayIndexInput.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
--- lucene/core/src/java/org/apache/lucene/store/ByteArrayIndexInput.java	(revision f1a30bfb00cc3f72ee30a3356c153aee3a402433)
+++ lucene/core/src/java/org/apache/lucene/store/ByteArrayIndexInput.java	(date 1539682852000)
@@ -101,9 +101,9 @@
     i |= (b & 0x7F) << 21;
     if (b >= 0) return i;
     b = bytes[pos++];
-    // Warning: the next ands use 0x0F / 0xF0 - beware copy/paste errors:
-    i |= (b & 0x0F) << 28;
-    if ((b & 0xF0) == 0) return i;
+    // Warning: the next ands use 0x07 / 0xF8 - beware copy/paste errors:
+    i |= (b & 0x07) << 28;
+    if ((b & 0xF8) == 0) return i;
     throw new RuntimeException("Invalid vInt detected (too many bits)");
   }
  
Index: lucene/core/src/java/org/apache/lucene/store/DataInput.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
--- lucene/core/src/java/org/apache/lucene/store/DataInput.java	(revision f1a30bfb00cc3f72ee30a3356c153aee3a402433)
+++ lucene/core/src/java/org/apache/lucene/store/DataInput.java	(date 1539682703000)
@@ -135,9 +135,9 @@
     i |= (b & 0x7F) << 21;
     if (b >= 0) return i;
     b = readByte();
-    // Warning: the next ands use 0x0F / 0xF0 - beware copy/paste errors:
-    i |= (b & 0x0F) << 28;
-    if ((b & 0xF0) == 0) return i;
+    // Warning: the next ands use 0x07 / 0xF8 - beware copy/paste errors:
+    i |= (b & 0x07) << 28;
+    if ((b & 0xF8) == 0) return i;
     throw new IOException("Invalid vInt detected (too many bits)");
   }
 
Index: lucene/core/src/java/org/apache/lucene/store/BufferedIndexInput.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
--- lucene/core/src/java/org/apache/lucene/store/BufferedIndexInput.java	(revision f1a30bfb00cc3f72ee30a3356c153aee3a402433)
+++ lucene/core/src/java/org/apache/lucene/store/BufferedIndexInput.java	(date 1539682852000)
@@ -213,9 +213,9 @@
       i |= (b & 0x7F) << 21;
       if (b >= 0) return i;
       b = buffer[bufferPosition++];
-      // Warning: the next ands use 0x0F / 0xF0 - beware copy/paste errors:
-      i |= (b & 0x0F) << 28;
-      if ((b & 0xF0) == 0) return i;
+      // Warning: the next ands use 0x07 / 0xF8 - beware copy/paste errors:
+      i |= (b & 0x07) << 28;
+      if ((b & 0xF8) == 0) return i;
       throw new IOException("Invalid vInt detected (too many bits)");
     } else {
       return super.readVInt();
Index: lucene/core/src/test/org/apache/lucene/store/TestByteArrayDataInput.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
--- lucene/core/src/test/org/apache/lucene/store/TestByteArrayDataInput.java	(revision f1a30bfb00cc3f72ee30a3356c153aee3a402433)
+++ lucene/core/src/test/org/apache/lucene/store/TestByteArrayDataInput.java	(date 1539682879000)
@@ -30,4 +30,23 @@
     in.reset(bytes, 1, 2);
     assertEquals("A", in.readString());
   }
+
+  public void testReadVInt() throws Exception {
+    byte[] bytes = new byte[] {-1, 65};
+    ByteArrayDataInput in = new ByteArrayDataInput(bytes);
+    assertEquals(8447, in.readVInt());
+
+    bytes = new byte[] {-1, -1, -1, -1, 0x0F};
+    in.reset(bytes, 0, bytes.length);
+    try {
+      in.readVInt();
+      fail();
+    } catch (RuntimeException e) {
+      assertEquals("Invalid vInt detected (too many bits)", e.getMessage());
+    }
+
+    bytes = new byte[] {-1, -1, -1, -1, 7};
+    in.reset(bytes, 0, bytes.length);
+    assertEquals(Integer.MAX_VALUE, in.readVInt());
+  }
 }
Index: lucene/core/src/java/org/apache/lucene/store/ByteArrayDataInput.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
--- lucene/core/src/java/org/apache/lucene/store/ByteArrayDataInput.java	(revision f1a30bfb00cc3f72ee30a3356c153aee3a402433)
+++ lucene/core/src/java/org/apache/lucene/store/ByteArrayDataInput.java	(date 1539682458000)
@@ -115,9 +115,9 @@
     i |= (b & 0x7F) << 21;
     if (b >= 0) return i;
     b = bytes[pos++];
-    // Warning: the next ands use 0x0F / 0xF0 - beware copy/paste errors:
-    i |= (b & 0x0F) << 28;
-    if ((b & 0xF0) == 0) return i;
+    // Warning: the next ands use 0x07 / 0xF8 - beware copy/paste errors:
+    i |= (b & 0x07) << 28;
+    if ((b & 0xF8) == 0) return i;
     throw new RuntimeException("Invalid vInt detected (too many bits)");
   }
  
