From 46122d54707c2b6437ed15d74dac4574b0565d11 Mon Sep 17 00:00:00 2001
From: Przemyslaw Szeremiota <przemyslaw.szeremiota@allegrogroup.com>
Date: Thu, 20 Apr 2017 08:38:10 +0200
Subject: [PATCH] RULE-689 | sort flush AIOOBE

---
 .../core/src/java/org/apache/lucene/index/BinaryDocValuesWriter.java  | 4 ++--
 lucene/core/src/java/org/apache/lucene/index/NormValuesWriter.java    | 4 ++--
 .../core/src/java/org/apache/lucene/index/NumericDocValuesWriter.java | 4 ++--
 3 files changed, 6 insertions(+), 6 deletions(-)

diff --git a/lucene/core/src/java/org/apache/lucene/index/BinaryDocValuesWriter.java b/lucene/core/src/java/org/apache/lucene/index/BinaryDocValuesWriter.java
index 0a59278..def8195 100644
--- a/lucene/core/src/java/org/apache/lucene/index/BinaryDocValuesWriter.java
+++ b/lucene/core/src/java/org/apache/lucene/index/BinaryDocValuesWriter.java
@@ -227,8 +227,8 @@ class BinaryDocValuesWriter extends DocValuesWriter {
         throw new NoSuchElementException();
       }
       final BytesRef v;
-      if (upto < size) {
-        int oldID = sortMap.newToOld(upto);
+      int oldID = sortMap.newToOld(upto);
+      if (oldID < size) {
         int length = (int) values.get(oldID);
         long pos = starts[oldID];
         bytesIterator.setPosition(pos);
diff --git a/lucene/core/src/java/org/apache/lucene/index/NormValuesWriter.java b/lucene/core/src/java/org/apache/lucene/index/NormValuesWriter.java
index 01ca877..2578b0b 100644
--- a/lucene/core/src/java/org/apache/lucene/index/NormValuesWriter.java
+++ b/lucene/core/src/java/org/apache/lucene/index/NormValuesWriter.java
@@ -147,8 +147,8 @@ class NormValuesWriter {
         throw new NoSuchElementException();
       }
       Long value;
-      if (upto < size) {
-        int oldUpto = sortMap.newToOld(upto);
+      int oldUpto = sortMap.newToOld(upto);
+      if (oldUpto < size) {
         value = values.get(oldUpto);
       } else {
         value = MISSING;
diff --git a/lucene/core/src/java/org/apache/lucene/index/NumericDocValuesWriter.java b/lucene/core/src/java/org/apache/lucene/index/NumericDocValuesWriter.java
index a307afd..cf9db15 100644
--- a/lucene/core/src/java/org/apache/lucene/index/NumericDocValuesWriter.java
+++ b/lucene/core/src/java/org/apache/lucene/index/NumericDocValuesWriter.java
@@ -252,8 +252,8 @@ class NumericDocValuesWriter extends DocValuesWriter {
         throw new NoSuchElementException();
       }
       Long value;
-      if (upto < size) {
-        int old = sortMap.newToOld(upto);
+      int old = sortMap.newToOld(upto);
+      if (old < size) {
         if (docsWithField.get(old)) {
           value = values.get(old);
         } else {
-- 
2.5.4 (Apple Git-61)

