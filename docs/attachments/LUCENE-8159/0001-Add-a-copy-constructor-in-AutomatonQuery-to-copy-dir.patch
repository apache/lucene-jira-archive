From af85b836d2789f811cec64a64534aebcb8ad26bd Mon Sep 17 00:00:00 2001
From: broustant <broustant@salesforce.com>
Date: Mon, 5 Feb 2018 14:42:27 +0100
Subject: [PATCH] Add a copy constructor in AutomatonQuery to copy directly the
 compiled automaton.

---
 .../java/org/apache/lucene/search/AutomatonQuery.java  | 18 ++++++++++++++++--
 1 file changed, 16 insertions(+), 2 deletions(-)

diff --git a/lucene/core/src/java/org/apache/lucene/search/AutomatonQuery.java b/lucene/core/src/java/org/apache/lucene/search/AutomatonQuery.java
index 7fb155d78e..9020910f9f 100644
--- a/lucene/core/src/java/org/apache/lucene/search/AutomatonQuery.java
+++ b/lucene/core/src/java/org/apache/lucene/search/AutomatonQuery.java
@@ -96,12 +96,26 @@ public class AutomatonQuery extends MultiTermQuery {
    *   will not go through the UTF32ToUTF8 conversion
    */
   public AutomatonQuery(final Term term, Automaton automaton, int maxDeterminizedStates, boolean isBinary) {
+    // TODO: we could take isFinite too, to save a bit of CPU in CompiledAutomaton ctor?:
+    this(term, automaton, new CompiledAutomaton(automaton, null, true, maxDeterminizedStates, isBinary),
+        isBinary);
+  }
+
+  /**
+   * Creates a new {@link AutomatonQuery} by copying another one, for a different field.
+   * This constructor reuses directly the already compiled automaton, saving much time.
+   */
+  public AutomatonQuery(AutomatonQuery automatonQuery, String field) {
+    this(new Term(field, automatonQuery.term.bytes()), automatonQuery.automaton,
+        automatonQuery.compiled, automatonQuery.automatonIsBinary);
+  }
+
+  private AutomatonQuery(Term term, Automaton automaton, CompiledAutomaton compiledAutomaton, boolean isBinary) {
     super(term.field());
     this.term = term;
     this.automaton = automaton;
     this.automatonIsBinary = isBinary;
-    // TODO: we could take isFinite too, to save a bit of CPU in CompiledAutomaton ctor?:
-    this.compiled = new CompiledAutomaton(automaton, null, true, maxDeterminizedStates, isBinary);
+    this.compiled = compiledAutomaton;
   }
 
   @Override
-- 
2.14.3 (Apple Git-98)

