Index: lucene/src/test/org/apache/lucene/search/payloads/TestPayloadNearQuery.java
===================================================================
--- lucene/src/test/org/apache/lucene/search/payloads/TestPayloadNearQuery.java	(revision 1144521)
+++ lucene/src/test/org/apache/lucene/search/payloads/TestPayloadNearQuery.java	(working copy)
@@ -42,6 +42,7 @@
 import org.apache.lucene.search.spans.SpanNearQuery;
 import org.apache.lucene.search.spans.SpanTermQuery;
 import org.apache.lucene.store.Directory;
+import org.apache.lucene.util.BytesRef;
 import org.apache.lucene.util.English;
 import org.apache.lucene.util.LuceneTestCase;
 import org.apache.lucene.util.TermContext;
@@ -315,9 +316,9 @@
       return new DefaultSimilarity() {
     
         @Override 
-        public float scorePayload(int docId, int start, int end, byte[] payload, int offset, int length) {
+        public float scorePayload(int docId, int start, int end, BytesRef payload) {
           //we know it is size 4 here, so ignore the offset/length
-          return payload[offset];
+          return payload.bytes[payload.offset];
         }
     
         //!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
Index: lucene/src/test/org/apache/lucene/search/payloads/TestPayloadTermQuery.java
===================================================================
--- lucene/src/test/org/apache/lucene/search/payloads/TestPayloadTermQuery.java	(revision 1144521)
+++ lucene/src/test/org/apache/lucene/search/payloads/TestPayloadTermQuery.java	(working copy)
@@ -16,6 +16,7 @@
  * limitations under the License.
  */
 
+import org.apache.lucene.util.BytesRef;
 import org.apache.lucene.util.LuceneTestCase;
 import org.apache.lucene.util.English;
 import org.apache.lucene.search.DefaultSimilarityProvider;
@@ -309,9 +310,9 @@
     
         // TODO: Remove warning after API has been finalized
         @Override
-        public float scorePayload(int docId, int start, int end, byte[] payload, int offset, int length) {
+        public float scorePayload(int docId, int start, int end, BytesRef payload) {
           //we know it is size 4 here, so ignore the offset/length
-          return payload[offset];
+          return payload.bytes[payload.offset];
         }
 
         //!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
Index: lucene/src/test/org/apache/lucene/search/spans/JustCompileSearchSpans.java
===================================================================
--- lucene/src/test/org/apache/lucene/search/spans/JustCompileSearchSpans.java	(revision 1144521)
+++ lucene/src/test/org/apache/lucene/search/spans/JustCompileSearchSpans.java	(working copy)
@@ -135,8 +135,8 @@
   static final class JustCompileSpanScorer extends SpanScorer {
 
     protected JustCompileSpanScorer(Spans spans, Weight weight,
-        Similarity similarity, Similarity.SloppyDocScorer docScorer) throws IOException {
-      super(spans, weight, similarity, docScorer);
+        Similarity.SloppyDocScorer docScorer) throws IOException {
+      super(spans, weight, docScorer);
     }
 
     @Override
Index: lucene/src/test/org/apache/lucene/search/TestDocValuesScoring.java
===================================================================
--- lucene/src/test/org/apache/lucene/search/TestDocValuesScoring.java	(revision 1144521)
+++ lucene/src/test/org/apache/lucene/search/TestDocValuesScoring.java	(working copy)
@@ -30,6 +30,7 @@
 import org.apache.lucene.index.codecs.CodecProvider;
 import org.apache.lucene.index.values.IndexDocValues.Source;
 import org.apache.lucene.store.Directory;
+import org.apache.lucene.util.BytesRef;
 import org.apache.lucene.util.LuceneTestCase;
 import org.apache.lucene.util.TermContext;
 
@@ -145,11 +146,6 @@
     }
 
     @Override
-    public float sloppyFreq(int distance) {
-      return sim.sloppyFreq(distance);
-    }
-
-    @Override
     public Stats computeStats(IndexSearcher searcher, String fieldName, float queryBoost, TermContext... termContexts) throws IOException {
       return sim.computeStats(searcher, fieldName, queryBoost, termContexts);
     }
@@ -189,6 +185,16 @@
         }
         
         @Override
+        public float computeSlopFactor(int distance) {
+          return sub.computeSlopFactor(distance);
+        }
+
+        @Override
+        public float computePayloadFactor(int doc, int start, int end, BytesRef payload) {
+          return sub.computePayloadFactor(doc, start, end, payload);
+        }
+
+        @Override
         public Explanation explain(int doc, Explanation freq) {
           Explanation boostExplanation = new Explanation((float) values.getFloat(doc), "indexDocValue(" + boostField + ")");
           Explanation simExplanation = sub.explain(doc, freq);
Index: lucene/src/test/org/apache/lucene/search/JustCompileSearch.java
===================================================================
--- lucene/src/test/org/apache/lucene/search/JustCompileSearch.java	(revision 1144521)
+++ lucene/src/test/org/apache/lucene/search/JustCompileSearch.java	(working copy)
@@ -265,11 +265,6 @@
     public byte computeNorm(FieldInvertState state) {
       throw new UnsupportedOperationException(UNSUPPORTED_MSG);
     }
-
-    @Override
-    public float sloppyFreq(int distance) {
-      throw new UnsupportedOperationException(UNSUPPORTED_MSG);
-    }
   }
   
   static final class JustCompileSimilarityProvider implements SimilarityProvider {
Index: lucene/src/test/org/apache/lucene/search/TestSimilarityProvider.java
===================================================================
--- lucene/src/test/org/apache/lucene/search/TestSimilarityProvider.java	(revision 1144521)
+++ lucene/src/test/org/apache/lucene/search/TestSimilarityProvider.java	(working copy)
@@ -27,6 +27,7 @@
 import org.apache.lucene.index.RandomIndexWriter;
 import org.apache.lucene.index.Term;
 import org.apache.lucene.store.Directory;
+import org.apache.lucene.util.BytesRef;
 import org.apache.lucene.util.LuceneTestCase;
 
 public class TestSimilarityProvider extends LuceneTestCase {
@@ -125,6 +126,11 @@
     public float idf(int docFreq, int numDocs) {
       return 1f;
     }
+
+    @Override
+    public float scorePayload(int doc, int start, int end, BytesRef payload) {
+      return 1f;
+    }
   }
   
   private class Sim2 extends TFIDFSimilarity {
@@ -147,5 +153,10 @@
     public float idf(int docFreq, int numDocs) {
       return 10f;
     }
+
+    @Override
+    public float scorePayload(int doc, int start, int end, BytesRef payload) {
+      return 1f;
+    }
   }
 }
Index: lucene/src/test/org/apache/lucene/index/TestOmitTf.java
===================================================================
--- lucene/src/test/org/apache/lucene/index/TestOmitTf.java	(revision 1144521)
+++ lucene/src/test/org/apache/lucene/index/TestOmitTf.java	(working copy)
@@ -19,6 +19,7 @@
 
 import java.io.IOException;
 
+import org.apache.lucene.util.BytesRef;
 import org.apache.lucene.util.LuceneTestCase;
 import org.apache.lucene.util.TermContext;
 import org.apache.lucene.util._TestUtil;
@@ -47,6 +48,7 @@
         @Override public Explanation idfExplain(TermContext[] terms, IndexSearcher searcher) throws IOException {
           return new Explanation(1.0f, "Inexplicable");
         }
+        @Override public float scorePayload(int doc, int start, int end, BytesRef payload) { return 1.0f; }
       };
     }
   }
Index: lucene/src/java/org/apache/lucene/search/Similarity.java
===================================================================
--- lucene/src/java/org/apache/lucene/search/Similarity.java	(revision 1144521)
+++ lucene/src/java/org/apache/lucene/search/Similarity.java	(working copy)
@@ -26,6 +26,7 @@
 import org.apache.lucene.index.IndexReader.AtomicReaderContext;
 import org.apache.lucene.index.Terms; // javadoc
 import org.apache.lucene.search.spans.SpanQuery; // javadoc
+import org.apache.lucene.util.BytesRef;
 import org.apache.lucene.util.SmallFloat; // javadoc
 import org.apache.lucene.util.TermContext;
 
@@ -100,9 +101,6 @@
  * @lucene.experimental
  */
 public abstract class Similarity {
-  
-  public static final int NO_DOC_ID_PROVIDED = -1;
-
   /**
    * Computes the normalization value for a field, given the accumulated
    * state of term processing for this field (see {@link FieldInvertState}).
@@ -120,43 +118,6 @@
    * @return the calculated byte norm
    */
   public abstract byte computeNorm(FieldInvertState state);
-
-  /** Computes the amount of a sloppy phrase match, based on an edit distance.
-   * This value is summed for each sloppy phrase match in a document to form
-   * the frequency to be used in scoring instead of the exact term count.
-   *
-   * <p>A phrase match with a small edit distance to a document passage more
-   * closely matches the document, so implementations of this method usually
-   * return larger values when the edit distance is small and smaller values
-   * when it is large.
-   *
-   * @see PhraseQuery#setSlop(int)
-   * @param distance the edit distance of this sloppy phrase match
-   * @return the frequency increment for this match
-   */
-  public abstract float sloppyFreq(int distance);
-
-  /**
-   * Calculate a scoring factor based on the data in the payload.  Overriding implementations
-   * are responsible for interpreting what is in the payload.  Lucene makes no assumptions about
-   * what is in the byte array.
-   * <p>
-   * The default implementation returns 1.
-   *
-   * @param docId The docId currently being scored.  If this value is {@link #NO_DOC_ID_PROVIDED}, then it should be assumed that the PayloadQuery implementation does not provide document information
-   * @param start The start position of the payload
-   * @param end The end position of the payload
-   * @param payload The payload byte array to be scored
-   * @param offset The offset into the payload array
-   * @param length The length in the array
-   * @return An implementation dependent float to be used as a scoring factor
-   *
-   */
-  // TODO: maybe switch this API to BytesRef?
-  public float scorePayload(int docId, int start, int end, byte [] payload, int offset, int length)
-  {
-    return 1;
-  }
   
   /**
    * Compute any collection-level stats (e.g. IDF, average document length, etc) needed for scoring a query.
@@ -216,7 +177,13 @@
      * @return document's score
      */
     public abstract float score(int doc, float freq);
+
+    /** Computes the amount of a sloppy phrase match, based on an edit distance. */
+    public abstract float computeSlopFactor(int distance);
     
+    /** Calculate a scoring factor based on the data in the payload. */
+    public abstract float computePayloadFactor(int doc, int start, int end, BytesRef payload);
+    
     /**
      * Explain the score for a single document
      * @param doc document id
Index: lucene/src/java/org/apache/lucene/search/payloads/PayloadNearQuery.java
===================================================================
--- lucene/src/java/org/apache/lucene/search/payloads/PayloadNearQuery.java	(revision 1144521)
+++ lucene/src/java/org/apache/lucene/search/payloads/PayloadNearQuery.java	(working copy)
@@ -32,6 +32,7 @@
 import org.apache.lucene.search.spans.SpanScorer;
 import org.apache.lucene.search.spans.SpanWeight;
 import org.apache.lucene.search.spans.Spans;
+import org.apache.lucene.util.BytesRef;
 import org.apache.lucene.util.ToStringUtils;
 
 import java.io.IOException;
@@ -186,7 +187,7 @@
 
     protected PayloadNearSpanScorer(Spans spans, Weight weight,
         Similarity similarity, Similarity.SloppyDocScorer docScorer) throws IOException {
-      super(spans, weight, similarity, docScorer);
+      super(spans, weight, docScorer);
       this.spans = spans;
     }
 
@@ -209,6 +210,9 @@
       }
     }
 
+    // TODO change the whole spans api to use bytesRef, or nuke spans
+    BytesRef scratch = new BytesRef();
+
     /**
      * By default, uses the {@link PayloadFunction} to score the payloads, but
      * can be overridden to do other things.
@@ -221,9 +225,12 @@
      */
     protected void processPayloads(Collection<byte[]> payLoads, int start, int end) {
       for (final byte[] thePayload : payLoads) {
+        scratch.bytes = thePayload;
+        scratch.offset = 0;
+        scratch.length = thePayload.length;
         payloadScore = function.currentScore(doc, fieldName, start, end,
-            payloadsSeen, payloadScore, similarity.scorePayload(doc,
-                spans.start(), spans.end(), thePayload, 0, thePayload.length));
+            payloadsSeen, payloadScore, docScorer.computePayloadFactor(doc,
+                spans.start(), spans.end(), scratch));
         ++payloadsSeen;
       }
     }
@@ -240,7 +247,7 @@
           payloadsSeen = 0;
           do {
             int matchLength = spans.end() - spans.start();
-            freq += similarity.sloppyFreq(matchLength);
+            freq += docScorer.computeSlopFactor(matchLength);
             Spans[] spansArr = new Spans[1];
             spansArr[0] = spans;
             getPayloads(spansArr);            
Index: lucene/src/java/org/apache/lucene/search/payloads/PayloadTermQuery.java
===================================================================
--- lucene/src/java/org/apache/lucene/search/payloads/PayloadTermQuery.java	(revision 1144521)
+++ lucene/src/java/org/apache/lucene/search/payloads/PayloadTermQuery.java	(working copy)
@@ -79,7 +79,7 @@
     @Override
     public Scorer scorer(AtomicReaderContext context, ScorerContext scorerContext) throws IOException {
       return new PayloadTermSpanScorer((TermSpans) query.getSpans(context),
-          this, similarity, similarity.sloppyDocScorer(stats, query.getField(), context));
+          this, similarity.sloppyDocScorer(stats, query.getField(), context));
     }
 
     protected class PayloadTermSpanScorer extends SpanScorer {
@@ -88,9 +88,8 @@
       protected int payloadsSeen;
       private final TermSpans termSpans;
 
-      public PayloadTermSpanScorer(TermSpans spans, Weight weight,
-          Similarity similarity, Similarity.SloppyDocScorer docScorer) throws IOException {
-        super(spans, weight, similarity, docScorer);
+      public PayloadTermSpanScorer(TermSpans spans, Weight weight, Similarity.SloppyDocScorer docScorer) throws IOException {
+        super(spans, weight, docScorer);
         termSpans = spans;
       }
 
@@ -106,7 +105,7 @@
         while (more && doc == spans.doc()) {
           int matchLength = spans.end() - spans.start();
 
-          freq += similarity.sloppyFreq(matchLength);
+          freq += docScorer.computeSlopFactor(matchLength);
           processPayload(similarity);
 
           more = spans.next();// this moves positions to the next match in this
@@ -122,17 +121,10 @@
           if (payload != null) {
             payloadScore = function.currentScore(doc, term.field(),
                                                  spans.start(), spans.end(), payloadsSeen, payloadScore,
-                                                 similarity.scorePayload(doc, spans.start(),
-                                                                         spans.end(), payload.bytes,
-                                                                         payload.offset,
-                                                                         payload.length));
+                                                 docScorer.computePayloadFactor(doc, spans.start(), spans.end(), payload));
           } else {
             payloadScore = function.currentScore(doc, term.field(),
-                                                 spans.start(), spans.end(), payloadsSeen, payloadScore,
-                                                 similarity.scorePayload(doc, spans.start(),
-                                                                         spans.end(), null,
-                                                                         0,
-                                                                         0));
+                                                 spans.start(), spans.end(), payloadsSeen, payloadScore, 1F);
           }
           payloadsSeen++;
 
Index: lucene/src/java/org/apache/lucene/search/spans/SpanWeight.java
===================================================================
--- lucene/src/java/org/apache/lucene/search/spans/SpanWeight.java	(revision 1144521)
+++ lucene/src/java/org/apache/lucene/search/spans/SpanWeight.java	(working copy)
@@ -67,7 +67,7 @@
 
   @Override
   public Scorer scorer(AtomicReaderContext context, ScorerContext scorerContext) throws IOException {
-    return new SpanScorer(query.getSpans(context), this, similarity, similarity.sloppyDocScorer(stats, query.getField(), context));
+    return new SpanScorer(query.getSpans(context), this, similarity.sloppyDocScorer(stats, query.getField(), context));
   }
 
   @Override
Index: lucene/src/java/org/apache/lucene/search/spans/SpanScorer.java
===================================================================
--- lucene/src/java/org/apache/lucene/search/spans/SpanScorer.java	(revision 1144521)
+++ lucene/src/java/org/apache/lucene/search/spans/SpanScorer.java	(working copy)
@@ -35,13 +35,11 @@
 
   protected int doc;
   protected float freq;
-  protected final Similarity similarity;
   protected final Similarity.SloppyDocScorer docScorer;
   
-  protected SpanScorer(Spans spans, Weight weight, Similarity similarity, Similarity.SloppyDocScorer docScorer)
+  protected SpanScorer(Spans spans, Weight weight, Similarity.SloppyDocScorer docScorer)
   throws IOException {
     super(weight);
-    this.similarity = similarity;
     this.docScorer = docScorer;
     this.spans = spans;
 
@@ -83,7 +81,7 @@
     freq = 0.0f;
     do {
       int matchLength = spans.end() - spans.start();
-      freq += similarity.sloppyFreq(matchLength);
+      freq += docScorer.computeSlopFactor(matchLength);
       more = spans.next();
     } while (more && (doc == spans.doc()));
     return true;
Index: lucene/src/java/org/apache/lucene/search/SloppyPhraseScorer.java
===================================================================
--- lucene/src/java/org/apache/lucene/search/SloppyPhraseScorer.java	(revision 1144521)
+++ lucene/src/java/org/apache/lucene/search/SloppyPhraseScorer.java	(working copy)
@@ -25,13 +25,11 @@
     private PhrasePositions repeats[];
     private PhrasePositions tmpPos[]; // for flipping repeating pps.
     private boolean checkedRepeats;
-    private final Similarity similarity;
     
-    SloppyPhraseScorer(Weight weight, PhraseQuery.PostingsAndFreq[] postings, Similarity similarity,
+    SloppyPhraseScorer(Weight weight, PhraseQuery.PostingsAndFreq[] postings,
                        int slop, Similarity.SloppyDocScorer docScorer) throws IOException {
         super(weight, postings, docScorer);
         this.slop = slop;
-        this.similarity = similarity;
     }
 
     /**
@@ -80,7 +78,7 @@
 
             int matchLength = end - start;
             if (matchLength <= slop)
-                freq += similarity.sloppyFreq(matchLength); // score match
+                freq += docScorer.computeSlopFactor(matchLength); // score match
 
             if (pp.position > end)
                 end = pp.position;
Index: lucene/src/java/org/apache/lucene/search/MultiPhraseQuery.java
===================================================================
--- lucene/src/java/org/apache/lucene/search/MultiPhraseQuery.java	(revision 1144521)
+++ lucene/src/java/org/apache/lucene/search/MultiPhraseQuery.java	(working copy)
@@ -221,8 +221,7 @@
           return s;
         }
       } else {
-        return new SloppyPhraseScorer(this, postingsFreqs, similarity,
-                                      slop, similarity.sloppyDocScorer(stats, field, context));
+        return new SloppyPhraseScorer(this, postingsFreqs, slop, similarity.sloppyDocScorer(stats, field, context));
       }
     }
 
Index: lucene/src/java/org/apache/lucene/search/PhraseQuery.java
===================================================================
--- lucene/src/java/org/apache/lucene/search/PhraseQuery.java	(revision 1144521)
+++ lucene/src/java/org/apache/lucene/search/PhraseQuery.java	(working copy)
@@ -251,7 +251,7 @@
         }
       } else {
         return
-          new SloppyPhraseScorer(this, postingsFreqs, similarity, slop, similarity.sloppyDocScorer(stats, field, context));
+          new SloppyPhraseScorer(this, postingsFreqs, slop, similarity.sloppyDocScorer(stats, field, context));
       }
     }
     
Index: lucene/src/java/org/apache/lucene/search/TFIDFSimilarity.java
===================================================================
--- lucene/src/java/org/apache/lucene/search/TFIDFSimilarity.java	(revision 1144521)
+++ lucene/src/java/org/apache/lucene/search/TFIDFSimilarity.java	(working copy)
@@ -22,6 +22,7 @@
 
 import org.apache.lucene.index.IndexReader.AtomicReaderContext;
 import org.apache.lucene.index.Term;
+import org.apache.lucene.util.BytesRef;
 import org.apache.lucene.util.TermContext;
 import org.apache.lucene.util.SmallFloat;
 
@@ -666,6 +667,34 @@
     return SmallFloat.floatToByte315(f);
   }
  
+  /** Computes the amount of a sloppy phrase match, based on an edit distance.
+   * This value is summed for each sloppy phrase match in a document to form
+   * the frequency to be used in scoring instead of the exact term count.
+   *
+   * <p>A phrase match with a small edit distance to a document passage more
+   * closely matches the document, so implementations of this method usually
+   * return larger values when the edit distance is small and smaller values
+   * when it is large.
+   *
+   * @see PhraseQuery#setSlop(int)
+   * @param distance the edit distance of this sloppy phrase match
+   * @return the frequency increment for this match
+   */
+  public abstract float sloppyFreq(int distance);
+
+  /**
+   * Calculate a scoring factor based on the data in the payload.  Implementations
+   * are responsible for interpreting what is in the payload.  Lucene makes no assumptions about
+   * what is in the byte array.
+   *
+   * @param docId The docId currently being scored.
+   * @param start The start position of the payload
+   * @param end The end position of the payload
+   * @param payload The payload byte array to be scored
+   * @return An implementation dependent float to be used as a scoring factor
+   */
+  public abstract float scorePayload(int doc, int start, int end, BytesRef payload);
+
   @Override
   public final Stats computeStats(IndexSearcher searcher, String fieldName, float queryBoost,
       TermContext... termContexts) throws IOException {
@@ -737,6 +766,16 @@
     }
     
     @Override
+    public float computeSlopFactor(int distance) {
+      return sloppyFreq(distance);
+    }
+
+    @Override
+    public float computePayloadFactor(int doc, int start, int end, BytesRef payload) {
+      return scorePayload(doc, start, end, payload);
+    }
+
+    @Override
     public Explanation explain(int doc, Explanation freq) {
       return explainScore(doc, freq, stats, norms);
     }
Index: lucene/src/java/org/apache/lucene/search/DefaultSimilarity.java
===================================================================
--- lucene/src/java/org/apache/lucene/search/DefaultSimilarity.java	(revision 1144521)
+++ lucene/src/java/org/apache/lucene/search/DefaultSimilarity.java	(working copy)
@@ -1,6 +1,7 @@
 package org.apache.lucene.search;
 
 import org.apache.lucene.index.FieldInvertState;
+import org.apache.lucene.util.BytesRef;
 
 /**
  * Licensed to the Apache Software Foundation (ASF) under one or more
@@ -51,7 +52,13 @@
   public float sloppyFreq(int distance) {
     return 1.0f / (distance + 1);
   }
-    
+  
+  /** The default implementation returns <code>1</code> */
+  @Override
+  public float scorePayload(int doc, int start, int end, BytesRef payload) {
+    return 1;
+  }
+
   /** Implemented as <code>log(numDocs/(docFreq+1)) + 1</code>. */
   @Override
   public float idf(int docFreq, int numDocs) {
