Index: lucene/core/src/test/org/apache/lucene/index/TestIndexWriterExceptions.java
===================================================================
--- lucene/core/src/test/org/apache/lucene/index/TestIndexWriterExceptions.java	(revision 1301472)
+++ lucene/core/src/test/org/apache/lucene/index/TestIndexWriterExceptions.java	(working copy)
@@ -1524,6 +1524,9 @@
     Document doc = new Document();
     Token t1 = new Token("foo", 0, 3);
     t1.setPositionIncrement(Integer.MAX_VALUE-500);
+    if (random.nextBoolean()) {
+      t1.setPayload(new Payload(new byte[] { 0x1 } ));
+    }
     TokenStream overflowingTokenStream = new CannedTokenStream(
         new Token[] { t1 }
     );
Index: lucene/core/src/java/org/apache/lucene/codecs/sep/SepPostingsReader.java
===================================================================
--- lucene/core/src/java/org/apache/lucene/codecs/sep/SepPostingsReader.java	(revision 1301472)
+++ lucene/core/src/java/org/apache/lucene/codecs/sep/SepPostingsReader.java	(working copy)
@@ -705,14 +705,14 @@
       }
 
       final int code = posReader.next();
-      assert code >= 0;
+
       if (storePayloads) {
         if ((code & 1) != 0) {
           // Payload length has changed
           payloadLength = posReader.next();
           assert payloadLength >= 0;
         }
-        position += code >> 1;
+        position += code >>> 1;
         pendingPayloadBytes += payloadLength;
         payloadPending = payloadLength > 0;
       } else {
Index: lucene/core/src/java/org/apache/lucene/codecs/pulsing/PulsingPostingsReader.java
===================================================================
--- lucene/core/src/java/org/apache/lucene/codecs/pulsing/PulsingPostingsReader.java	(revision 1301472)
+++ lucene/core/src/java/org/apache/lucene/codecs/pulsing/PulsingPostingsReader.java	(working copy)
@@ -475,7 +475,7 @@
           payloadLength = postings.readVInt();
           //System.out.println("PR     new payload len=" + payloadLength);
         }
-        position += code >> 1;
+        position += code >>> 1;
         payloadRetrieved = false;
       } else {
         position += postings.readVInt();
Index: lucene/test-framework/src/java/org/apache/lucene/codecs/mockintblock/MockFixedIntBlockPostingsFormat.java
===================================================================
--- lucene/test-framework/src/java/org/apache/lucene/codecs/mockintblock/MockFixedIntBlockPostingsFormat.java	(revision 1301472)
+++ lucene/test-framework/src/java/org/apache/lucene/codecs/mockintblock/MockFixedIntBlockPostingsFormat.java	(working copy)
@@ -109,7 +109,6 @@
           @Override
           protected void flushBlock() throws IOException {
             for(int i=0;i<buffer.length;i++) {
-              assert buffer[i] >= 0;
               out.writeVInt(buffer[i]);
             }
           }
Index: lucene/test-framework/src/java/org/apache/lucene/codecs/mockintblock/MockVariableIntBlockPostingsFormat.java
===================================================================
--- lucene/test-framework/src/java/org/apache/lucene/codecs/mockintblock/MockVariableIntBlockPostingsFormat.java	(revision 1301472)
+++ lucene/test-framework/src/java/org/apache/lucene/codecs/mockintblock/MockVariableIntBlockPostingsFormat.java	(working copy)
@@ -117,7 +117,6 @@
           
           @Override
           protected int add(int value) throws IOException {
-            assert value >= 0;
             buffer[pendingCount++] = value;
             // silly variable block length int encoder: if
             // first value <= 3, we write N vints at once;
Index: lucene/test-framework/src/java/org/apache/lucene/codecs/mocksep/MockSingleIntIndexOutput.java
===================================================================
--- lucene/test-framework/src/java/org/apache/lucene/codecs/mocksep/MockSingleIntIndexOutput.java	(revision 1301472)
+++ lucene/test-framework/src/java/org/apache/lucene/codecs/mocksep/MockSingleIntIndexOutput.java	(working copy)
@@ -53,7 +53,6 @@
   /** Write an int to the primary file */
   @Override
   public void write(int v) throws IOException {
-    assert v >= 0;
     out.writeVInt(v);
   }
 
Index: lucene/test-framework/src/java/org/apache/lucene/analysis/CannedTokenStream.java
===================================================================
--- lucene/test-framework/src/java/org/apache/lucene/analysis/CannedTokenStream.java	(revision 1301472)
+++ lucene/test-framework/src/java/org/apache/lucene/analysis/CannedTokenStream.java	(working copy)
@@ -21,6 +21,7 @@
 
 import org.apache.lucene.analysis.tokenattributes.CharTermAttribute;
 import org.apache.lucene.analysis.tokenattributes.OffsetAttribute;
+import org.apache.lucene.analysis.tokenattributes.PayloadAttribute;
 import org.apache.lucene.analysis.tokenattributes.PositionIncrementAttribute;
 
 /**
@@ -32,6 +33,7 @@
   private final CharTermAttribute termAtt = addAttribute(CharTermAttribute.class);
   private final PositionIncrementAttribute posIncrAtt = addAttribute(PositionIncrementAttribute.class);
   private final OffsetAttribute offsetAtt = addAttribute(OffsetAttribute.class);
+  private final PayloadAttribute payloadAtt = addAttribute(PayloadAttribute.class);
   
   public CannedTokenStream(Token[] tokens) {
     this.tokens = tokens;
@@ -48,6 +50,7 @@
       termAtt.append(token.toString());
       posIncrAtt.setPositionIncrement(token.getPositionIncrement());
       offsetAtt.setOffset(token.startOffset(), token.endOffset());
+      payloadAtt.setPayload(token.getPayload());
       return true;
     } else {
       return false;
