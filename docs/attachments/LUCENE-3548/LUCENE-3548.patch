Index: lucene/CHANGES.txt
===================================================================
--- lucene/CHANGES.txt	(revision 1195967)
+++ lucene/CHANGES.txt	(working copy)
@@ -706,6 +706,9 @@
 * LUCENE-3541: IndexInput's default copyBytes() implementation was not safe 
   across multiple threads, because all clones shared the same buffer.
   (Robert Muir)
+  
+* LUCENE-3548: Fix CharsRef#append to extend length of the existing char[]
+  and presever existing chars. (Simon Willnauer) 
 
 New Features
 
Index: lucene/src/java/org/apache/lucene/util/CharsRef.java
===================================================================
--- lucene/src/java/org/apache/lucene/util/CharsRef.java	(revision 1195967)
+++ lucene/src/java/org/apache/lucene/util/CharsRef.java	(working copy)
@@ -189,18 +189,22 @@
    * Copies the given array into this CharsRef starting at offset 0
    */
   public void copy(char[] otherChars, int otherOffset, int otherLength) {
+    grow(otherLength);
+    System.arraycopy(otherChars, otherOffset, this.chars, 0,
+        otherLength);
     this.offset = 0;
-    append(otherChars, otherOffset, otherLength);
+    this.length = otherLength;
   }
 
   /**
-   * Appends the given array to this CharsRef starting at the current offset
+   * Appends the given array to this CharsRef
    */
   public void append(char[] otherChars, int otherOffset, int otherLength) {
-    grow(this.offset + otherLength);
-    System.arraycopy(otherChars, otherOffset, this.chars, this.offset,
+    final int newLength = length + otherLength;
+    grow(this.offset + newLength);
+    System.arraycopy(otherChars, otherOffset, this.chars, this.offset+length,
         otherLength);
-    this.length = otherLength;
+    this.length += otherLength;
   }
 
   @Override
Index: lucene/src/test/org/apache/lucene/util/TestCharsRef.java
===================================================================
--- lucene/src/test/org/apache/lucene/util/TestCharsRef.java	(revision 1195967)
+++ lucene/src/test/org/apache/lucene/util/TestCharsRef.java	(working copy)
@@ -38,4 +38,33 @@
       assertEquals(utf8[i].utf8ToString(), utf16[i].toString());
     }
   }
+  
+  public void testAppend() {
+    CharsRef ref = new CharsRef();
+    StringBuilder builder = new StringBuilder();
+    int numStrings = atLeast(10);
+    for (int i = 0; i < numStrings; i++) {
+      char[] charArray = _TestUtil.randomRealisticUnicodeString(random, 1, 100).toCharArray();
+      int offset = random.nextInt(charArray.length);
+      int length = charArray.length - offset;
+      builder.append(charArray, offset, length);
+      ref.append(charArray, offset, length);  
+    }
+    
+    assertEquals(builder.toString(), ref.toString());
+  }
+  
+  public void testCopy() {
+    int numIters = atLeast(10);
+    for (int i = 0; i < numIters; i++) {
+      CharsRef ref = new CharsRef();
+      char[] charArray = _TestUtil.randomRealisticUnicodeString(random, 1, 100).toCharArray();
+      int offset = random.nextInt(charArray.length);
+      int length = charArray.length - offset;
+      String str = new String(charArray, offset, length);
+      ref.copy(charArray, offset, length);
+      assertEquals(str, ref.toString());  
+    }
+    
+  }
 }
