Index: lucene/core/src/java/org/apache/lucene/codecs/perfield/PerFieldDocValuesFormat.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
--- lucene/core/src/java/org/apache/lucene/codecs/perfield/PerFieldDocValuesFormat.java	(revision c561ffe6350965716222a8afb29ac72d29060b5c)
+++ lucene/core/src/java/org/apache/lucene/codecs/perfield/PerFieldDocValuesFormat.java	(revision )
@@ -135,13 +135,11 @@
 
       // Group each consumer by the fields it handles
       for (FieldInfo fi : mergeState.mergeFieldInfos) {
+        if (fi.getDocValuesType() == DocValuesType.NONE) {
+          continue;
+        }
         DocValuesConsumer consumer = getInstance(fi);
-        Collection<String> fieldsForConsumer = consumersToField.get(consumer);
-        if (fieldsForConsumer == null) {
-          fieldsForConsumer = new ArrayList<>();
-          consumersToField.put(consumer, fieldsForConsumer);
-        }
-        fieldsForConsumer.add(fi.name);
+        consumersToField.computeIfAbsent(consumer, k -> new ArrayList<>()).add(fi.name);
       }
 
       // Delegate the merge to the appropriate consumer
Index: lucene/core/src/java/org/apache/lucene/codecs/perfield/PerFieldPostingsFormat.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
--- lucene/core/src/java/org/apache/lucene/codecs/perfield/PerFieldPostingsFormat.java	(revision c561ffe6350965716222a8afb29ac72d29060b5c)
+++ lucene/core/src/java/org/apache/lucene/codecs/perfield/PerFieldPostingsFormat.java	(revision )
@@ -183,6 +183,7 @@
       // Assign field -> PostingsFormat
       for(String field : fields) {
         FieldInfo fieldInfo = writeState.fieldInfos.fieldInfo(field);
+        assert fieldInfo.getIndexOptions() != IndexOptions.NONE;
 
         final PostingsFormat format = getPostingsFormatForField(field);
   
